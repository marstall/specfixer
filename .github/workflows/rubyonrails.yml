# This workflow uses actions that are not certified by GitHub.  They are
# provided by a third-party and are governed by separate terms of service,
# privacy policy, and support documentation.
#
# This workflow will install a prebuilt Ruby version, install dependencies, and
# run tests and linters.
name: "Ruby on Rails CI"
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      RAILS_ENV: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      # Add or replace dependency steps here
      - name: Install Ruby and gems
        uses: ruby/setup-ruby@78c01b705fd9d5ad960d432d3a0cfa341d50e410 # v1.179.1
        with:
          ruby-version: '3.3.1'
          bundler-cache: true
      # Add or replace database setup steps here
      - name: Set up database schema
        run: bin/rails db:create db:migrate
      # Add or replace test runners here
      - name: Run tests
        run: bin/rake


  # Job 1: Create autofix branch when tests fail
  create-branch:
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && needs.test.result == 'failure'
    outputs:
      branch_name: ${{ steps.branch-info.outputs.branch_name }}
      failure_type: ${{ steps.branch-info.outputs.failure_type }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.AUTOFIX_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch info
        id: branch-info
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="autofix/ai-test-fix-${TIMESTAMP}"
          FAILURE_TYPE="test"
          
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "failure_type=${FAILURE_TYPE}" >> $GITHUB_OUTPUT

      - name: Create autofix branch
        run: |
          git checkout -b ${{ steps.branch-info.outputs.branch_name }}
          git push origin ${{ steps.branch-info.outputs.branch_name }}

  # Job 2: Use AI to generate fixes for test failures
  ai-fix:
    runs-on: ubuntu-latest
    needs: [test, create-branch]
    if: always() && needs.create-branch.result == 'success'
    outputs:
      has_changes: ${{ steps.ai-analysis.outputs.has_changes }}
    steps:
      - name: Checkout autofix branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-branch.outputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.AUTOFIX_TOKEN }}

      - name: Install Ruby and gems
        uses: ruby/setup-ruby@78c01b705fd9d5ad960d432d3a0cfa341d50e410
        with:
          ruby-version: '3.3.1'
          bundler-cache: true

      - name: Analyze commit history and failures
        id: commit-analysis
        run: |
          # Find the last successful commit on main
          LAST_SUCCESS_SHA=$(git log origin/main --format="%H" --grep="✅" -1 || git log origin/main --format="%H" -10 | tail -1)
          echo "Last successful commit: ${LAST_SUCCESS_SHA}"
          
          # Get recent commits (max 5) since last success
          COMMITS_JSON=$(git log ${LAST_SUCCESS_SHA}..HEAD --format='{"sha":"%H","message":"%s","author":"%an","date":"%ad"}' --date=iso --max-count=5 | jq -s '.')
          echo "commits_json<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Get diffs for each commit
          DIFFS=""
          for commit in $(git log ${LAST_SUCCESS_SHA}..HEAD --format="%H" --max-count=5); do
            DIFF=$(git show $commit --format="Commit: %H%nAuthor: %an%nDate: %ad%nMessage: %s%n" --date=iso)
            DIFFS="${DIFFS}\n\n--- COMMIT DIFF ---\n${DIFF}"
          done
          
          echo "commit_diffs<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DIFFS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get current test failure details
        id: failure-details
        run: |
          echo "Capturing test failures..."
          TEST_OUTPUT=$(bundle exec rspec 2>&1 || true)
          
          echo "error_output<<EOF" >> $GITHUB_OUTPUT
          echo "TEST FAILURES:" >> $GITHUB_OUTPUT
          echo "$TEST_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate AI fix using GitHub Copilot
        id: ai-analysis
        uses: actions/github-script@v7
        env:
          COMMIT_DIFFS: ${{ steps.commit-analysis.outputs.commit_diffs }}
          ERROR_OUTPUT: ${{ steps.failure-details.outputs.error_output }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          github-token: ${{ secrets.AUTOFIX_TOKEN }}
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            // Get the commit diffs and error output safely
            const commitDiffs = process.env.COMMIT_DIFFS || 'No recent commits found';
            const errorOutput = process.env.ERROR_OUTPUT || 'No error output available';
            
            // Construct comprehensive prompt for AI
            const prompt = [
              'You are an expert Ruby on Rails developer tasked with fixing test failures in a CI/CD pipeline.',
              '',
              '## FAILURE CONTEXT',
              'Failure Type: Test failures',
              'Repository: Rails application with RSpec test suite',
              '',
              '## RECENT COMMITS (that may have introduced the issue)',
              commitDiffs,
              '',
              '## CURRENT TEST FAILURES',
              errorOutput,
              '',
              '## YOUR TASK',
              'Analyze the test failures and recent commits to identify the root cause.',
              'Generate specific file changes to fix the failing tests.',
              'Focus on:',
              '1. Correcting test failures and broken functionality',
              '2. Fixing syntax errors that cause test crashes',
              '3. Resolving missing dependencies or setup issues',
              '4. Maintaining Rails best practices and test integrity',
              '',
              '## OUTPUT FORMAT',
              'For each file that needs changes, provide:',
              '1. File path',
              '2. Complete corrected file content',
              '3. Brief explanation of changes made',
              '',
              'Please provide practical, working solutions that will make all tests pass.'
            ].join('\n');
            
            // Use GitHub Copilot API to generate fixes
            try {
              console.log("Starting AI analysis with GitHub Copilot...");
              console.log("Prompt context prepared:");
              console.log(prompt);
              
              let hasChanges = false;
              
              // Get list of files that might need fixing based on test failures
              const filesToAnalyze = await getFilesToAnalyze(errorOutput);
              console.log(`Found ${filesToAnalyze.length} files to analyze:`, filesToAnalyze);
              
              // Process each file with Copilot
              for (const filePath of filesToAnalyze) {
                try {
                  console.log(`Analyzing file: ${filePath}`);
                  
                  // Read current file content
                  const currentContent = fs.readFileSync(filePath, 'utf8');
                  
                  // Create Copilot completion request
                  const completionPrompt = `${prompt}

## CURRENT FILE: ${filePath}
\`\`\`ruby
${currentContent}
\`\`\`

Based on the test failures and commit history above, please provide a corrected version of this file that will fix the failing tests. Return only the corrected Ruby code without any explanations or markdown formatting.`;

                  // Call OpenAI API (GitHub Copilot backend)
                  // Note: This requires OPENAI_API_KEY to be set in repository secrets
                  const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      model: 'gpt-4',
                      messages: [
                        {
                          role: 'system',
                          content: 'You are an expert Ruby on Rails developer. Analyze code and fix test failures.'
                        },
                        {
                          role: 'user',
                          content: completionPrompt
                        }
                      ],
                      max_tokens: 2000,
                      temperature: 0.1
                    })
                  });
                  
                  const responseData = await response.json();
                  
                  if (responseData && responseData.choices && responseData.choices[0]) {
                    const suggestedFix = responseData.choices[0].message.content.trim();
                    
                    // Validate the suggestion looks like Ruby code
                    if (suggestedFix && suggestedFix.length > 10 && !suggestedFix.includes('I cannot') && !suggestedFix.includes('I apologize')) {
                      console.log(`Copilot suggested fix for ${filePath}`);
                      
                      // Apply the fix
                      fs.writeFileSync(filePath, suggestedFix, 'utf8');
                      hasChanges = true;
                      
                      console.log(`Applied AI fix to ${filePath}`);
                    } else {
                      console.log(`Copilot suggestion for ${filePath} was not applicable`);
                    }
                  }

                } catch (fileError) {
                  console.log(`Error processing ${filePath}:`, fileError.message);
                }
              }

              // If no specific files were identified, try a more general approach
              if (!hasChanges && filesToAnalyze.length === 0) {
                console.log("No specific files identified, trying general Copilot analysis...");
                
                // Use OpenAI API to suggest what files might need changes
                const analysisResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    model: 'gpt-5',
                    messages: [
                      {
                        role: 'system',
                        content: 'You are an expert Ruby on Rails developer. Analyze test failures and suggest specific file changes.'
                      },
                      {
                        role: 'user',
                        content: `${prompt}

Please analyze the test failures and suggest which specific files need to be modified and what changes should be made. Format your response as:

FILE: path/to/file.rb
CHANGES: Brief description of what needs to be changed
CODE: The corrected code for this file

Repeat for each file that needs changes.`
                      }
                    ],
                    max_tokens: 1500,
                    temperature: 0.2
                  })
                });
                
                const analysisData = await analysisResponse.json();
                
                if (analysisData && analysisData.choices && analysisData.choices[0]) {
                  const analysis = analysisData.choices[0].message.content.trim();
                  console.log("AI analysis:", analysis);
                  
                  // Parse the analysis and apply suggested changes
                  hasChanges = await parseAndApplyAnalysis(analysis);
                }
              }

              // Check final git status
              try {
                const gitStatus = execSync('git status --porcelain', { encoding: 'utf8' });
                if (gitStatus.trim()) {
                  hasChanges = true;
                  console.log("Final changes detected:");
                  console.log(gitStatus);
                } else {
                  console.log("No changes were generated by AI analysis");
                }
              } catch (error) {
                console.log("Error checking git status:", error.message);
              }

              core.setOutput('has_changes', hasChanges.toString());

            } catch (error) {
              console.error("Copilot API error:", error.message);

              // Fallback: try basic pattern-based fixes
              console.log("Falling back to pattern-based fixes...");
              let hasChanges = await applyBasicFixes(errorOutput);
              core.setOutput('has_changes', hasChanges.toString());
            }

            // Helper function to identify files that might need fixing
            async function getFilesToAnalyze(errorOutput) {
              const files = [];
              const lines = errorOutput.split('\n');
              
              for (const line of lines) {
                // Look for file paths in RSpec output
                const fileMatch = line.match(/^\s*#\s+(.+\.rb):(\d+)/);
                if (fileMatch) {
                  const filePath = fileMatch[1];
                  if (fs.existsSync(filePath) && !files.includes(filePath)) {
                    files.push(filePath);
                  }
                }
                
                // Look for other file references
                const pathMatch = line.match(/([a-zA-Z_\/]+\.rb)/);
                if (pathMatch) {
                  const filePath = pathMatch[1];
                  if (fs.existsSync(filePath) && !files.includes(filePath)) {
                    files.push(filePath);
                  }
                }
              }

              return files.slice(0, 5); // Limit to 5 files to avoid API limits
            }

            // Helper function to parse Copilot analysis and apply changes
            async function parseAndApplyAnalysis(analysis) {
              let hasChanges = false;
              const sections = analysis.split('FILE:');
              
              for (const section of sections) {
                if (!section.trim()) continue;
                
                const lines = section.trim().split('\n');
                const filePath = lines[0].trim();
                
                if (!fs.existsSync(filePath)) continue;
                
                // Find the CODE section
                const codeIndex = lines.findIndex(line => line.startsWith('CODE:'));
                if (codeIndex === -1) continue;
                
                const codeLines = lines.slice(codeIndex + 1);
                const newContent = codeLines.join('\n').trim();
                
                if (newContent && newContent.length > 10) {
                  fs.writeFileSync(filePath, newContent, 'utf8');
                  hasChanges = true;
                  console.log(`Applied analysis-based fix to ${filePath}`);
                }
              }

              return hasChanges;
            }

            // Fallback function for basic pattern-based fixes
            async function applyBasicFixes(errorOutput) {
              let hasChanges = false;
              
              // Look for common test failure patterns and apply simple fixes
              if (errorOutput.includes('undefined method') || errorOutput.includes('NoMethodError')) {
                console.log("Detected method-related errors, applying basic fixes...");
                // This would contain basic pattern-matching fixes
                // For now, just log that we detected the issue
              }

              if (errorOutput.includes('NameError') || errorOutput.includes('uninitialized constant')) {
                console.log("Detected constant/variable errors, applying basic fixes...");
                // This would contain basic pattern-matching fixes
              }

              return hasChanges;
            }

  # Job 3: Commit AI changes and create PR
  commit-and-pr:
    runs-on: ubuntu-latest
    needs: [test, create-branch, ai-fix]
    if: always() && needs.ai-fix.result == 'success' && needs.ai-fix.outputs.has_changes == 'true'
    steps:
      - name: Checkout autofix branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-branch.outputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.AUTOFIX_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit AI-generated fixes
        run: |
          git add -A
          git commit -m "🤖 AI-generated fixes for test failures
          
          Auto-generated by GitHub Actions using AI analysis of:
          - Recent commit history and changes
          - Current test failures and error details
          - Rails application patterns and best practices
          
          This commit attempts to resolve the failing tests automatically."

      - name: Push changes
        run: |
          git push origin ${{ needs.create-branch.outputs.branch_name }}

      - name: Create PR with AI fix details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTOFIX_TOKEN }}
          script: |
            const title = `🤖 AI Autofix: Resolve test failures`;
            
            const body = `## 🤖 AI-Generated Test Fix
            
            This PR was automatically created by GitHub Actions using AI analysis to fix failing tests.
            
            ### 🔍 Analysis Summary
            - **Failure Type:** Test failures
            - **Branch:** \`${{ needs.create-branch.outputs.branch_name }}\`
            - **Generated:** ${new Date().toISOString()}
            
            ### 🛠️ AI-Applied Fixes
            The AI system analyzed recent commits and current test failures to generate targeted fixes for:
            - Test failures and broken functionality
            - Code logic issues and bugs
            - Missing dependencies or setup problems
            - Rails application integrity issues
            
            ### 🧪 Next Steps
            1. **Review the changes** in this PR carefully
            2. **Run tests locally** to verify fixes work as expected  
            3. **Merge** if all tests pass and fixes are appropriate
            4. **Modify** if additional changes are needed
            
            ### ⚠️ Important Note
            This is an AI-generated fix. Please review all changes before merging to ensure they align with your codebase standards and requirements.
            
            *Generated by GitHub Actions AI Test Autofix System*`;
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              head: '${{ needs.create-branch.outputs.branch_name }}',
              base: 'main',
              body: body
            });
            
            console.log(`Created AI autofix PR: ${pr.html_url}`);
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['🤖 ai-generated', 'autofix', 'ci-failure', 'needs-review']
            });
